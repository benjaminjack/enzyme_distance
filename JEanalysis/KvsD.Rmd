---
title: "Functional constraints are felt far from the active site"
author: "Julian Echave"
date: "26 July 2015"
output:
  html_document:
    theme: cerulean
    toc: yes
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache=TRUE,warning=FALSE)
```




```{r echo=FALSE,cache=TRUE}
# Set up the data.frame to be used in the analysis (dfx)

# Load libraries
library(ggplot2)
library(reshape2)
library(moments)

# Define functions 
myErrorBar= function(x) {
    result = c(mean(x) - sd(x), mean(x) + sd(x))
    names(result) = c("ymin", "ymax")
    result
}
myMeanErrorBar= function(x) {
    n = length(x)
    result = c(mean(x) - 1.96*sd(x)/sqrt(n), mean(x) + 1.96*sd(x)/sqrt(n))
    names(result) = c("ymin", "ymax")
    result
}

myCI = function(x) {
    alpha = 0.05
    result = quantile(x,probs = c(alpha,1-alpha))
    names(result) = c("ymin", "ymax")
    result
}
# Read data
dataset = read.csv("data/dataset_full.csv") # proteins and some properties
proteinProperties = read.csv("output/proteinProperties.csv") # other protein properties
gofTab = read.csv("output/all_gofTab.csv") # protein-by-protein goodness-of-fit table
fittedRates = read.csv("output/all_fittedRates.csv") # protein-by-protein Ks and fits using different linear models
# pre-process data
fittedRates = fittedRates[,c("pdb","y","x1","x2","x3","rate1","rate2","rate3","rate12","rate13","rate23","rate123")]
names(fittedRates) = c("pdb","K","x1","x2","x3","K1","K2","K3","K12","K13","K23","K123")

# add protein info (nsites, etc)
df1 = merge(proteinProperties,fittedRates,by="pdb")
df1 = merge(dataset,df1,by="pdb")

# Set filter to keep only some proteins or sites (e.g. multimeric, etc). dfx is the dataframe containing all the information we'll need for the analysis
# filter = df1$ndomains == 1 & df1$multimer == 0
filter = T
dfx = subset(df1,filter) 

# Add residuals
dfx$KmK0 = dfx$K - 1
dfx$KmK1 = dfx$K - dfx$K1
dfx$KmK2 = dfx$K - dfx$K2
dfx$KmK3 = dfx$K - dfx$K3
dfx$KmK12 = dfx$K - dfx$K12
dfx$KmK23 = dfx$K - dfx$K23
dfx$KmK13 = dfx$K - dfx$K13
dfx$KmK123 = dfx$K - dfx$K123

dfx$K123mK12 = dfx$K123 - dfx$K12
dfx$K13mK1 = dfx$K13 - dfx$K1
dfx$K23mK2 = dfx$K23 - dfx$K2

# Add factors that may affect the fit
# whether the ndomains is 1 or more
dfx$oneDomain = dfx$ndomains == 1

# label proteins according to their size
sizeBins = quantile(dfx$nsites,probs=c(0,0.333,0.667,1))
sizeBins[1] = sizeBins[1]-1
dfx$size = cut(dfx$nsites,breaks=sizeBins)
levels(dfx$size) = c("Small","Medium","Large")

# label proteins according to the accessibility of thir active site
rsaActiveBins = round(quantile(dfx$rsa_active_site,probs = c(0,0.333,0.667,1)),3)
rsaActiveBins[1] = rsaActiveBins[1] - 0.001
rsaActiveBins[4] = rsaActiveBins[4] + 0.001
dfx$rsaActive = cut(dfx$rsa_active_site,breaks=rsaActiveBins)

# Define shells of active site neighborhood (first shell is from 2.5 to 7.5, second from 7.5 to 12.5, etc)
dfx$shell = cut(dfx$x3,breaks = c(-.1,2.5,7.5,12.5,17.5,22.5,27.5,32.5,37.5,42.5,47.5,52.5,max(dfx$x3)))
levels(dfx$shell) = seq(length(levels(dfx$shell)))-1 # rename shell levels
```
# Motivation

The best two structural predictors of site-specific rates of evolution are Relative Solvent Accessibility (RSA) and Weighted Contact Number (WCN). It has been reported that distance ($D$) to the active site also affects rates. Here, we want to see if this is the case for a large and diverse dataset of enzymes. We are especially interested in whether the active site affects sites beyond its immediate neighborhood, i.e. if there're any long-range functional constraints.

# Results

## Notation
- `K` are the site-specific empirical rates
- `x1` is WCN, calculated using side-chains and a single chain, even for multimers 
- `x2` is RSA, calculated using a single chain, even for multimers (interface residues were filtered away, so this is the same as the multi-chain RSA)
- `x3` of a residue is it's distance to the closest active residue
- `K1` are the rates predicted by model `lm(K~pdb*x1)`; the model will also be called K1. `K2`, `K12`, etc. are defined similarly.

## The active site constrains evolution beyond WCN and RSA
The following table compares null models $M_{\text{null}}$ and alternative models $M_{\text{alt}}$. 
The alternative model in each row is the null plus variable `x3` (distance to the active site). 
Model fitness is measured using $R^2$, the square correlation coefficient between empirical and predicted rates.
The models are linear models with parameters that may depend on the protein: `Kij...` is `lm(K ~ pdb*xi + pdb*xj + ...)`.
Note that in practice, this global model results in exactly the same predictions as fitting a model to each protein. The advantage of considering as a global model is that instead of averaging goodness-of-fit measures over proteins, we can calcualte such measures for the global model. 
The table that follows compares models using coefficients of determination (square empirical-predicted Pearson correlations) $R^2$. 
I also calculated other measures of model fit: AIC, AICc, BIC, $R_{\\text{adj}}^2$, and Spearman's $S^2$ and $S_{\\text{adj}}^2$. 
Results are consistent, so that we will use $R^2$ from now on. 

```{r echo=F}
modelComparisonTable = data.frame(
    "nullModel" = c("K0","K1","K2","K12"),
    "altModel" = c("K3","K13","K23","K123"),
    "nullR2" = c(0,as.vector(cor(dfx$K,dfx[,c("K1","K2","K12")])^2)),
    "altR2"  = as.vector(cor(dfx$K,dfx[,c("K3","K13","K23","K123")])^2)
    )
modelComparisonTable$deltaR2 = modelComparisonTable$altR2 - modelComparisonTable$nullR2
```



```


```{r echo=F}
tab = modelComparisonTable
names(tab) = c("$M_{\\text{null}}$","$M_{\\text{alt}}$","$R^2_{\\text{null}}$","$R^2_{\\text{alt}}$","$\\Delta R^2$")
knitr::kable(tab, format = "markdown",digits=2)
```

This table shows that:

1. `K1`and `K2`are better predictors than `K3`
2. Yet, `K3` can account for  `r round(100*tab[1,4],0)` % of the variation of site-specific empirical rates `K`.
3. Adding `x3` *allways* improves predictions:  $\\Delta R^2$ of the last column are all positive (p-value of $\\Delta R^2$ is $<< 10^{-3}$).
4. Adding `x3` to `K1` explains an extra `r round(100*tab[2,5],0)` % of rate variation and to `K12`, an extra `r round(100*tab[4,5],0)`%. 
5. The effect of adding `x3` to model `K2` is especially large $R^2$ goes from `r round(100*tab[3,3],0)`% for `K2` to `r round(100*tab[3,4],0)`% for `K23`. Interestingly, this makes `K23` better than `K13` (however, this does depend on the goodness-of-fit measure: both models are similar if Spearman correlations are used, which suggests possible non-linear effects).
6. In any case, the best model is `K123`, the model that considers the three predictors; `K123` explains `r round(100*tab[4,4],0)`% of the rate variation. 

Summarizing, including distance to active site in the models allways improves predictions: the active site contributes to evolutionary constraints beyond the structure-based measures WCN and RSA.

## What's the direct effect of distance?
To partition the overall explained variance of site-specific rates, we can use path analysis. 
We group WCN and RSA into a "structure" variable `s` and distance into a "function" variable `f`.
Since we're pooling all sites together, we use as independent variables the one-variable predictions for each protein `K1`, `K2`, and `K3`. It's convenient to see this as a linear scaling of the un-scaled variables for each protein. Alternatively, we could use z-scaled variables (results are very similar). This can be considered as a path model based on the original variables, with interactions with pdb.

```{r echo=FALSE}
library(plyr)
source("R/pathAnalysis123.R")

pathAll = pathAnalysis123(dfx,c("K1","K2"),"K3","K")

```
Considering all sites of all proteins together, we find that the direct contribution of "structure" is $\beta_{12} = `r round(pathAll[1],2)`$, with almost identical loadings of RSA and WCN. The direct contribution of "function" is $\beta_{3} = `r round(pathAll[2],2)`$. Thus functional constraints are about 1/3 of the overall constraints.

Protein size has an effect. As we see in the next table, the direct contribution of `x3` is larger for smaller proteins.

```{r echo=FALSE}
pathBySize =  ddply(.data = dfx , .variables = .(size), pathAnalysis123)
pathBySize = rbind(cbind("size"="all",pathAll),pathBySize)
names(pathBySize) = c("Protein Size","$\\beta_{12}$","$\\beta_{3}$")
knitr::kable(pathBySize, format = "markdown",digits=2)
```

One possible interpretation is, I speculate, that the active site has a limited radius of influence (even if as we'll see it may be rather large) so that for larger proteins the region influenced by the active site is a smaller proportion of the protein.

The location of the active site also has an effect. When the active site is more exposed, the direct contributin of `x3` is larger, as can be seen in the next table.

```{r echo=FALSE}
pathByRsaActive=  ddply(.data = dfx , .variables = .(rsaActive), pathAnalysis123)
pathByRsaActive = rbind(cbind("rsaActive"="all",pathAll),pathByRsaActive)
names(pathByRsaActive) = c("rsaActive","$\\beta_{12}$","$\\beta_{3}$")
knitr::kable(pathByRsaActive, format = "markdown",digits=2)
```

Structural variables correlate better twith `x3` when the active site is buried and close to the center, in which case they can "steal" some of the effect of `x3` making the direct contribution of `x3` seem smaller.


To summarize, there is a significant effect of functional constraints of about 1/3 of overall constraints and the relative importance of functional constraints is larger for smaller proteins with exposed active sites.



##  Slizing up sites into shells
We know that active-site residues are especially conserved, and so are their immediate neighbors.
Do active-site constraints go beyond the actual catalytic residues and its first shell of neighbors?
We're interested in possible **long-range** constraints. *What is long?*

It is convenient to cut sites into slizes according to their distance to the active sites `x3`.
To find an appropriate thinkness for each slize, we plot the radial the distribution  $g(x3) = \rho(x3)/x3^2$. This is shown in the next figure for the whole dataset.

```{r  echo=FALSE}
dat = dfx[dfx$x3>0,c("shell","size","x3")]
w = 1/dat$x3^2
w = w/sum(w)
dat$w = w
ggplot(dat,aes(x=x3,weight=w)) + xlim(0,32.5) +
    geom_density(fill="blue",size=2,position="identity") +
    geom_vline(xintercept= c(2.5,7.5,12.5,17.5,22.5,27.5,32.5),alpha=1,size=2,linetype="dotted",col="red")
```

This radial distribution  has a first peak at $x_3 \sim 5$ and the first minimum at $x_3 \sim 7.5$.
Thus, we slized up sites into **shells** according to their distance to the active site by cutting the continuous `x3`range at points `c(0,2,5,7.5,12.5,17.5,22.5,27.5,...)`. The cuts are at the red dotted lines of the previous figure.
The following figure shows the actual distribution of sites among shells (no `1/x3^2` weighting).

```{r  echo=FALSE}
dat = dfx[dfx$shell %in% levels(dfx$shell),c("shell","size","x3")]
# qplot(x3,..count..,data=dat,geom="density",fill=shell,position="stack") 
ggplot(dat,aes(x=shell,fill=shell)) + geom_histogram(aes(y=..count..),col="black",size=1,width=1)  
```

### Seven shells are enough to study long-range effects while avoiding artifacts
When distance is of the order of the protein size, we will see later that there may be artifacts in the `K vs x3` behavior.
However, from the previous figure we see that most sites are in the first, say, 7 shells (`x3 <= 32.5`). 
This is more clearly seen in in the following figure.

```{r  echo=FALSE}
fn = ecdf(dfx$x3)
dat = dfx
dat$Pcum = fn(dfx$x3)
x3 = seq(0,50,by=0.1)
Pcum = fn(x3)
dat2 = data.frame(x3,Pcum)
ggplot(dat2,aes(x=x3,y=Pcum)) + geom_line(size=2,col="blue")  + 
    geom_point(x=32.5,y=fn(32.5),col="red",size=5) +
    geom_text(x=32.5,y=.95,col="red",size=10,label = paste(round(fn(32.5)*100,0),"% Sites with x3 <=32.5")) 

```

Thus, almost 90% of sites are within 32.5 A of the active site.
To study long-range effects we do not need to go to farther 32.5 A. 
Therefore, we will mostly focus on the first 7 shells (up to 32.5A).

## Site-specific rates increase with distance from the active site
How does rate depend on distance to active site?
The following figure shows mean rates.

```{r  echo=FALSE}
filter = dfx$shell %in% levels(dfx$shell)[1:11]
dat = melt(dfx[filter,],id.vars = c("shell","rsaActive","size","x3"),measure.vars = c("K"))

p = ggplot(dat,aes(y=value,x=shell)) + ylim(0,3) +
    geom_violin(aes(fill=shell),trim=TRUE,scale="width",alpha=.7) + 
    stat_summary(fun.data="mean_cl_normal",conf.int=0.99,size=1,col="blue") +
    stat_summary(aes(group=variable),fun.y=mean,geom="line",col="blue",size=1) 
p
```

The mean rate for each shell increases continuously (almost linearly) with distance to the active site up to shell 7 (32.5 A).
Then, it levels-off. Why? 

### How rapidly rates increase with distance depends on protein size
The previous figure considers all sites of all proteins. 
Proteins vary in size from `r min(dfx$nsites)` sites to `r max(dfx$nsites)` sites, a huge range. 
To see whether protein size affects the `K vs. x3` relationship, we separate the whole set into three sets using `quantiles`: `r quantile(dfx$nsites,probs=c(0,0.333,0.667,1))`. 
Then we plot `K vs x3` for each set:

```{r echo=FALSE}
p + facet_grid(~size)
```

The mean rate increases up to a maximum then levels-off.
Where exactly the influence of the active site ends (where the `K vs. x3` curve levels-off) depends on protein size.
Rates increase up to shell 6 for small proteins, shell 7 for medium proteins, and shell 8 for large proteins.
The *maximum* mean rate is similar, but the *slope* with which rate rises is larger for smaller proteins.

*To be added in future version: the slope `b3` in protein-by-protein fits decreases with protein size (correlation = -0.25). Also, using a protein-dependent smooth fit does not improve much over a linear fit which just assumes rates are proportional to x3. Thus the leveling off of the rate-distance curve is due to pooling together sites of proteins with different sizes.)*

To summarize, the leveling-off of the rate-distance curve does not mean that constraints actually disappear abruptly at a certain cutoff distance, but, rather, is an `artifact` of grouping all sites of all proteins together.

We note in the plot for small proteins an odd behavior for large distance. This artifact is due to the small number of sites in those shells. To avoid such artifacts, we will focus on the first 7 shells (shells 0 to 6).

## Is the dependence of rate on distance evidence of functional constraints?
Interpreting the `K vs. x3` dependence found above as evidence of functional constraints is a mistake; 
it might well be that rates are determined by **other** predictors and that the `x3` effect is just indirect.  
To find out whether this is the case, we need a more detailed analysis.

The best structural predictors of rates are WCN (`x1`) and RSA (`x2`). 
For a spherical protein, WCN is maximum at the center and decreases towards the surface; since the active site of many proteins is buried, close to the high-WCN region; `x3` correlates with `x1`. 
Also, since for most enzymes active sites are buried in the core, as distance from the active site increases, sites are more solvent exposed, and RSA increases; `x3` correlates with RSA. 
*Is there any direct effect of `x3`, beyond the effects of `x1`and/or `x2`?*

We saw before that `x3` does provide an independent contribution to the variation of rates among sites, which shows that it is not just a proxy of the structural factors. 
However, due considering the `K vs. x3` relationship overestimates the effect of `x3`. 
When used by itself `x3` accounts for `r round(100*cor(dfx$K,dfx$K3)^2,0)`% of the rate variation,  but it's *unique contributions* depend on whether `x1` and/or `x2` are explicitly considered (unique contributions are the last column of the table we showed at the beginning).

An overall model-fit comparison does not tell us whether there are long-range effects of `x3`.
To study such effects, we need to compare the rate-distance dependence of  null models based on `x1` and/or `x2` with their counterpart altarnative models obtained by adding `x3`. 


### Comparing rates
The following figure compares the empirical rate `K` with predictions of the null models (without x3) and alternative models (which include x3).

```{r  echo=FALSE,fig.width=7,fig.height=3.5}
filter = dfx$shell %in% levels(dfx$shell)[1:7]
null1 = melt(dfx[filter,],id.vars = c("shell","rsaActive","size"),measure.vars = c("K","K1","K13"))
levels(null1$variable) = c("K","K(null)","K(null+x3)")
null1$nullModel = factor("null = K1")

null2 = melt(dfx[filter,],id.vars = c("shell","rsaActive","size"),measure.vars = c("K","K2","K23"))
levels(null2$variable) = c("K","K(null)","K(null+x3)")
null2$nullModel = factor("null = K2")

null12 = melt(dfx[filter,],id.vars = c("shell","rsaActive","size"),measure.vars = c("K","K12","K123"))
levels(null12$variable) = c("K","K(null)","K(null+x3)")
null12$nullModel = factor("null = K12")

dat = rbind(null12,null1,null2)

p = ggplot(dat,aes(y=value,x=shell,col=variable)) + 
    stat_summary(fun.data="mean_cl_normal",conf.int=0.99,size=1) +
    stat_summary(aes(group=variable),fun.y=mean,geom="line",size=1) 

p +  facet_grid(nullModel~.)

# p +  geom_violin(aes(fill=shell),trim=TRUE,scale="width",alpha=.7)  

```

Several issues can be noted:

- Non-x3 models already predict an increase of rate with distance from the active site (green curves). This was to be expected because the active site is frequently near the center of the core of the protein and thus distance to the active site increases with increasing RSA and decreasing WCN.
- However, Non-x3 models **overestimate rates** whin up to shell 3, which is 17.5 A away from the active site (green curves vs. red curves).
- The difference between Non-x3 predictions and empirical rates decreases somoothly with distance.
- Comparing the different panels, we see that RSA (rightmost panel) is particularly bad at predicting rates close to the active site: RSA predicts a constant rate for the whole protein core (RSA = 0) and cannot account for any dependence within the core.
- In contrast, WCN (`K1`) does a better job at predicting the rate-dependence close to the active site. Yet, it is not good enough.
- In all cases, adding `x3` to the model makes the predicted K-vs-x3 curves fit much better the empirical K-vs-x3 curves (red vs. blue).

There seems to be a long-range effect of the active site.  It affects not just the first shell but at least the first 3 (17.5 A away). 

### Comparing residuals
To better see the independent effect of x3, it is convenient plot the difference between rates and their fits. 

```{r  echo=FALSE,fig.width=7,fig.height=3.5}
filter = dfx$shell %in% levels(dfx$shell)[1:7]

null1 = melt(dfx[filter,],id.vars = c("shell","rsaActive","size"),measure.vars = c("KmK1","KmK13"))
levels(null1$variable) = c("K-K(null)","K-K(null+x3)")
null1$nullModel = factor("null = K1")

null2 = melt(dfx[filter,],id.vars = c("shell","rsaActive","size"),measure.vars = c("KmK2","KmK23"))
levels(null2$variable) = c("K-K(null)","K-K(null+x3)")
null2$nullModel = factor("null = K2")

null12 = melt(dfx[filter,],id.vars = c("shell","rsaActive","size"),measure.vars = c("KmK12","KmK123"))
levels(null12$variable) = c("K-K(null)","K-K(null+x3)")
null12$nullModel = factor("null = K12")

dat = rbind(null12,null1,null2)

p = ggplot(dat,aes(y=value,x=shell,col=variable)) + 
    stat_summary(fun.data="mean_cl_normal",conf.int=0.99,size=1) +
    stat_summary(aes(group=variable),fun.y=mean,geom="line",size=1.5) 

p +  facet_grid(nullModel~.)


```

Here it is clearer that rates increase with distance from the active site *even after the effects of `x1` and/or `x2` are substracted* (red curves). Including `x3` fixes this (green lines). Note, however, that even for x3-based models the rate of active sites (shell 0) is somewhat overestimated. (This is fixed by including explicitly a categorical variable, and could possibly be fixed by using a non-linear x3 fit).  

We note that residuals vary quite strongly, which can be seen using a violin plot:

```{r echo=FALSE}
p +  facet_grid(nullModel~.) + geom_violin(aes(fill=variable),col="black",trim=TRUE,scale="width",alpha=.3) + ylim(-1,1) 
```

### Effect of the location of the active site within the protein
As wa said, the correlation between `x3` and the other perdictors is expected when the active site is buried in the core close to the center.
This is frequently the case, but not allways.
When it is not the case, we would expect the difference between non-x3 models and their x3-based counterparts to be more evident.
To study the effect of the location of the active site, we calculated for each active site the average solvent accessibility.
The distribution of active-site RSA is:

```{r echo=FALSE}
cuts = round(quantile(proteinProperties$rsa_active_site,probs = c(0,0.333,0.677,1)),3)
ggplot(proteinProperties,aes(x=rsa_active_site)) + geom_density(fill="blue") + geom_vline(xintercept = cuts[-1],linetype="dotted",col="red",size=2)
```

We split the dataset in three sets of approximately equal number of proteins using active-site RSA cuts `r round(quantile(proteinProperties$rsa_active_site,probs = c(0,0.333,0.677,1)),2)` (dotted red lines in the previous figure). Then we analyzed the residuals for each set separately.



```{r echo=FALSE}
p + facet_grid(nullModel~rsaActive)

```

The non-x3 models (red lines) become worse at predicting rates as active-site RSA increases. This is the expected behavior: RSA and WCN will be able to "predict" the rate in the neighborhood of the active site *only when the active site is in the core and close to the center* (i.e. not exposed). RSA does a bad job allways, because the best it can do is predict a single average small rate for the whole protein core (bottom panels). WCN, on the other hand, seems to "predict" the rates in the active site neighborhood when the active site is within the large WCN region (middle row, left panel), but **not** when this is not the case (exposed active sites: middle row, right panel). 
Adding `x3` fixes this wrong behavior. Interestingly, for proteins with buried sites (left panels), adding `x3` results in zero mean residuals even for the active site (shell 0). In contrast, for proteins with exposed sites `x3` cannot compensate completely the large overestimation of the non-x3 models. When the active site is buried close to the center, all constraints have the same "sign", whereas for exposed active sites, functional constraints (x3) and structural constraints (RSA and/or WCN) have opposite signs, which could explain this behavior.



### Effect of protein size
How does protein size affect the previous comparison?
Let's repeat the previous comparison grouping proteins by size:

```{r echo=FALSE}
p + facet_grid(nullModel~size)

```

Comparing plots of the same row (same null model) we see that the effect of the active site goes to longer ranges for larger proteins (non-x3 models overestimate rates up to shell 3 for small proteins, shell 4 for medium proteins, and shell 5 for large proteins and overestimate rates for laerger distances (green curves). Adding `x3` fixes this, except for active-site residues, where rates are still overestimated (negative residual).


# Conclusion
The active site imposes functional constraints in addition to the structural constraints due to RSA and/or WCN.
Global model fit improves when distance from the active site `x3` is added to models based on RSA and/or WCN. 
The unique contribution of `x3` is significant and rather large: it explains an extra 
`r round(100*(cor(dfx$K123,dfx$K)^2 - cor(dfx$K12,dfx$K)^2),0)`% 
of the variance of site-specific rates when controlling WCN and RSA. This is an increase of 
`r round(100*((cor(dfx$K123,dfx$K)^2 - cor(dfx$K12,dfx$K)^2))/cor(dfx$K12,dfx$K)^2,0)`% 
when going from model K12 to K123.
More importantly, this improvement is **qualitative** it accounts for the variation of rates as the distance of sites from the active site increases. Non-x3 models are unable to reproduce the correct behavior of rate vs. distance, especially for proteins for which the active site is exposed to the solvent (i.e. not buried close to the center where WCN and RSA predict low rates).
Moreover, functional constraints are not limited to the active residues and their immediate neighbors: sites within at least the first three shells have lower rates than expected from structural constraints alone for small proteins and up to the first five shells for large proteins.
In a word, in addition to structural constraints, the active site imposes independent long-range functional constraints.


# Methods 
## Empirical rates
Empirical site-specific rates K were obtained from multiple sequence alignments using Rate4Site.

## Structural predictors
RSA and WCN (for side-chain geometric centers) were calculated using either a single chain or the whole biological unit. When the biological unit is not monomeric, the difference between RSA calculated in these ways is zero unless sites are involved in the interface between subunits. deltaRSA = RSAmonomer - RSAmultimer < 0 is the filter used to eliminate them (see below).

## Filters
Rates and predictors were calculated for all sites, then some sites were eliminated before further analysis. 

* I've eliminated sites with glycine because they are usually in odd conformations and are subject to different constraints (Dean2002).
Note that side-chain WCN is not defined for glycines, so that filtering away sites with any NA values would also eliminate them.

* I've eliminated sites at interfaces between subunits of multimeric proteins because they are subject to constraints that are different from the rest (Franzosa2009).

# Notes 

- Errors of K1 (and K12) predictions are not so bad because the effect of x3 "leaks" into K1 via the K~K1 fit (i.e. in trying to fit K, x1 will account for part of x3). Thus, Error(K12) vs x3 underestimates the effect of x3 on rates (i.e. K12 is different from the x1+x2 portion of K123). Even so, since Error(K12) is negative for the first shells, there's an effect of x3 that's missing, even for proteins with buried active sites.

- K23 is better than K13 and K12. Also, when studying core-sites (RSA = 0), K3 is much better than K1. It is possible that WCN works just as a proxy of RSA + Distance (actually, K123 is the best model, which means that there is some contribution of WCN. However, it may just be "fixing" possible nonlinearities of x3, errors in the estimation of RSA, etc). 

# Supplementary figures

Adding x3 improves predictions as far as 30A of the active site and more (if the protein is large enough!)

```{r echo=TRUE}
ggplot(dfx,aes(x=x3,y=(abs(KmK123)-abs(KmK12))/(abs(K12)+abs(K123)) ))  +geom_smooth(method=lm,formula=y~ns(x,3)) + facet_grid(size~rsaActive)
```

